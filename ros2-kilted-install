#!/bin/bash
# Script by Chiawei
set -e
print_step() { echo "==== $1 ===="; }
print_info() { echo "[INFO] $1"; }
print_warning() { echo "[WARNING] $1"; }
print_error() { echo "[ERROR] $1"; }

clean_bashrc_config() {
    if grep -q "#------------- HOSTPC CONFIG" ~/.bashrc; then
        sed -i '/#------------- HOSTPC CONFIG/,/#------------- HOSTPC CONFIG/d' ~/.bashrc
    fi
}

# ---------------- 系統檢查 ----------------
check_ubuntu() {
    if ! grep -q "ubuntu" /etc/os-release; then
        print_error "此腳本僅支援 Ubuntu 系統"
        exit 1
    fi
    
    if grep -q "24.04" /etc/os-release; then
        print_info "檢測到 Ubuntu 24.04 (Noble)，適用於 ROS 2 Kilted"
    else
        print_warning "ROS 2 Kilted 官方支援 Ubuntu 24.04 (Noble)"
        print_warning "您的系統版本可能不完全相容"
    fi
    
    print_info "繼續安裝..."
}

# ---------------- ROS 2 Kilted 安裝 ----------------
install_ros2_base() {

    print_step "Step 1: 設定 locale"
    sudo apt update && sudo apt install -y locales
    sudo locale-gen en_US en_US.UTF-8
    sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
    export LANG=en_US.UTF-8

    print_step "Step 2: 設定 ROS 來源"
    sudo apt install -y software-properties-common curl
    sudo add-apt-repository universe -y

    export ROS_APT_SOURCE_VERSION=$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')
    curl -L -o /tmp/ros2-apt-source.deb \
    "https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.$(. /etc/os-release && echo ${UBUNTU_CODENAME:-${VERSION_CODENAME}})_all.deb"
    sudo dpkg -i /tmp/ros2-apt-source.deb

    print_step "Step 3: 更新系統"
    sudo apt update
    sudo apt upgrade -y

    print_step "Step 4: 安裝 ROS 2 Kilted Desktop"
    sudo apt install -y ros-kilted-desktop
    sudo apt install -y ros-kilted-ros-base
    sudo apt install -y ros-dev-tools

    print_step "Step 5: rosdep 初始化"
    if [ ! -f /etc/ros/rosdep/sources.list.d/20-default.list ]; then
        sudo rosdep init
    fi
    rosdep update

    print_step "Step 6: 設定環境"
    source /opt/ros/kilted/setup.bash
}

# ---------------- 主程式 ----------------
main() {

    check_ubuntu
    install_ros2_base

    print_step "安裝完成: ROS 2 Kilted"
    echo "安裝版本 : $ROS_DISTRO"
    echo "開新終端機後輸入以下指令進行測試："
    echo ""
    echo "ROS 2 測試指令："
    echo "1. ros2 run demo_nodes_cpp talker               # C++ 範例發布者"
    echo "2. ros2 run demo_nodes_cpp listener             # C++ 範例訂閱者 [新增終端機]"
    echo "3. ros2 run demo_nodes_py talker                # Python 範例發布者"
    echo "4. ros2 run demo_nodes_py listener              # Python 範例訂閱者 [新增終端機]"
    echo "5. ros2 run turtlesim turtlesim_node            # Turtlesim 節點"
    echo "6. ros2 run turtlesim turtle_teleop_key         # Turtle Teleop [新增終端機]"
    echo ""

    clean_bashrc_config

    cat << 'EOF' >> ~/.bashrc
#------------- HOSTPC CONFIG ---------------------------------------------------------------
# ROS2 環境配置
source /opt/ros/kilted/setup.bash

# ROS 網路設定
interface=$(ip route | grep default | head -1 | awk '{print $5}')
export IPAddress=$(ip -4 addr show $interface | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
export ROS_IP=$IPAddress
export ROBOT_IP=$IPAddress
export ROS_MASTER_URI=http://$ROBOT_IP:11311

# Alias 跳轉
alias cw='cd ~/ros2_ws'
alias cs='cd ~/ros2_ws/src'
alias cm='cd ~/ros2_ws && colcon build'

# 終端顯示
echo ""
echo "------------------- HOST PC INFO -------------------"
echo -e " ROS_MASTER_URI: \033[32m$ROS_MASTER_URI\033[0m"
echo -e " HOST PC ROS_IP: \033[32m$ROS_IP\033[0m"
echo "-------------------------------------------------------------"
echo ""
#------------- HOSTPC CONFIG ---------------------------------------------------------------
EOF

    print_warning "請重新開啟終端機或執行 'source ~/.bashrc' 來載入新環境"
    echo "=== Script by Chiawei ==="
}

main
